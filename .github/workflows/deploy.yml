name: deploy

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - master
  workflow_dispatch:

env:
  RUBY_VERSION: "3.3.2"
  BUNDLER_VERSION: "2.5.11"

jobs:
  build:
    name: Build site
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bats build-essential ca-certificates curl make shellcheck libgsl-dev libffi-dev
          sudo gem install bundler:${{ env.BUNDLER_VERSION }}
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ hashFiles('**/package-lock.json') }}
      - name: Install JS dependencies
        run: npm install
      - name: Check Jekyll configuration
        run: bundle exec jekyll doctor
      - name: Build site
        run: bundle exec jekyll build --lsi --profile
        env:
          JEKYLL_ENV: production
      - name: Cache jekyll site
        uses: actions/cache@v3
        with:
          path: "_site/"
          key: ${{ runner.os }}-${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: crazy-max/ghaction-github-pages@v2
        with:
          target_branch: gh-pages
          build_dir: _site
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Check HTML with HTMLProofer
        uses: chabad360/htmlproofer@master
        with:
          directory: ./_site
          arguments: "--only-4xx --ignore-status-codes '400,403,409,429'"

  clean:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Clean build artifacts
        run: bundle exec jekyll clean
